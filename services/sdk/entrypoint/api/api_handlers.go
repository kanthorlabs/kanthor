package api

import (
	"github.com/go-chi/chi/v5"
	"github.com/kanthorlabs/common/gateway/httpx"
	httpxmw "github.com/kanthorlabs/common/gateway/httpx/middleware"
	httpxwriter "github.com/kanthorlabs/common/gateway/httpx/writer"
	openapi "github.com/kanthorlabs/kanthor/openapi" // docs is generated by Swag CLI, you have to import it.
	"github.com/kanthorlabs/kanthor/services/permissions"
	swagger "github.com/swaggo/http-swagger/v2"
)

type Error httpxwriter.E // @name Error

func (service *sdk) httpx() error {
	handler, err := httpx.New(&service.conf.Sdk.Gateway, service.logger)
	if err != nil {
		return err
	}

	// healthz
	RegisterHealthzRoutes(handler, service)

	// openapi
	handler.Get("/openapi/*", swagger.Handler(
		swagger.PersistAuthorization(true),
		swagger.InstanceName(openapi.SwaggerInfoSdk.InstanceName()),
	))

	// protected routes
	handler.Route("/api", func(router chi.Router) {
		router.Use(httpxmw.Idempotency(service.infra.Idempotency(), service.conf.Sdk.Gateway.Idempotency.Disabled))
		router.Use(httpxmw.Authn(
			service.infra.Passport(),
			httpxmw.AuthnWithCache(service.infra.Cache()),
			httpxmw.AuthnWithFallback(permissions.Sdk),
			// use default time to live - 1 hour
		))
		RegisterAccountRoutes(router, service)

		RegisterApplicationRoutes(router, service)
		RegisterEndpointRoutes(router, service)
		RegisterRouteRoutes(router, service)
		RegisterMessageRoutes(router, service)
	})

	return service.server.UseHttpx(handler)
}
